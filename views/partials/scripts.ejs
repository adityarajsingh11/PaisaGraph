<script>
  const formatMoney = (n) => '₹' + Number(n || 0).toLocaleString();

  document.addEventListener('DOMContentLoaded', () => {
    loadAll();
  });

  async function loadAll() {
    await loadSummary();
    await loadTransactions();
  }

  async function loadSummary() {
    const res = await fetch('/api/transactions/summary');
    const json = await res.json();
    const d = json.data || { income: 0, expense: 0, balance: 0 };
    document.getElementById('totalIncome').textContent = formatMoney(d.income);
    document.getElementById('totalExpense').textContent = formatMoney(d.expense);
    document.getElementById('balance').textContent = formatMoney(d.balance);
    drawChart(d.income, d.expense);
  }

  let chart = null;
  function drawChart(income, expense) {
    const ctx = document.getElementById('pieChart');
    if (chart) chart.destroy();
    chart = new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: ['Income', 'Expense'],
        datasets: [{ data: [income, expense], backgroundColor: ['#22c55e', '#ef4444'] }]
      },
      options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
    });
  }

  async function loadTransactions() {
    const res = await fetch('/api/transactions');
    const json = await res.json();
    const data = json.data || [];
    const container = document.getElementById('transactionsContainer');
    if (!data.length) {
      container.innerHTML = '<p class="text-gray-500">No transactions found.</p>';
      return;
    }

    let html = `<table class="w-full text-sm text-left border">
      <thead class="bg-gray-100">
        <tr>
          <th class="p-2">S.No</th>
          <th class="p-2">Title</th>
          <th class="p-2">Category</th>
          <th class="p-2">Amount</th>
          <th class="p-2">Type</th>
          <th class="p-2">Date</th>
          <th class="p-2">Actions</th>
        </tr>
      </thead>
      <tbody>`;

    data.forEach((t, i) => {
      // ✅ Only date (no time)
      const onlyDate = new Date(t.date).toLocaleDateString('en-IN', {
        day: '2-digit',
        month: 'short',
        year: 'numeric',
        timeZone: 'Asia/Kolkata'
      });

      html += `<tr class="border-t">
        <td class="p-2">${i + 1}</td>
        <td class="p-2">${t.title}</td>
        <td class="p-2">${t.category}</td>
        <td class="p-2">${formatMoney(t.amount)}</td>
        <td class="p-2 capitalize">${t.type}</td>
        <td class="p-2">${onlyDate}</td>
        <td class="p-2">
          <button onclick="editTransaction('${t._id}')" class="text-yellow-600 hover:underline">Edit</button>
          <button onclick="deleteTransaction('${t._id}')" class="text-red-600 hover:underline ml-2">Delete</button>
        </td>
      </tr>`;
    });

    html += '</tbody></table>';
    container.innerHTML = html;
  }

  async function deleteTransaction(id) {
    if (!confirm('Delete this transaction?')) return;
    const res = await fetch('/api/transactions/' + id, { method: 'DELETE' });
    if (res.ok) loadAll();
  }

  async function editTransaction(id) {
    const res = await fetch('/api/transactions');
    const js = await res.json();
    const t = js.data.find(x => x._id === id);
    if (!t) return alert('Not found');
    const title = prompt('Title', t.title);
    const amount = prompt('Amount', t.amount);
    if (!title) return;
    await fetch('/api/transactions/' + id, {
      method: 'PUT',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ title, amount })
    });
    loadAll();
  }

  document.getElementById('addForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const fd = new FormData(e.target);
    const data = {};
    fd.forEach((v, k) => data[k] = v);
    await fetch('/api/transactions', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(data)
    });
    e.target.reset();
    loadAll();
  });
</script>
